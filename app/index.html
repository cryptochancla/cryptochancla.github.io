<!doctype html>
<html lang="fr" class="h-100">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="CryptoPanoramix">
    <title>CryptoChancla</title>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>

    <link href="style.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/hmac-sha256.js"></script>


  </head>
  <body class="text-white bg-dark">

    <h3><i class="bi bi-calculator-fill"></i>CryptoChancla</h3><p>Pour fonctionner, l'onglet ne doit être ni fermé ni rafraîchi.</p>



  <!-- Modal -->
  <div class="modal fade" id="modalCleAPI" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalCleAPILabel">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark">
        <div class="modal-header">
          <h5 class="modal-title" id="modalCleAPILabel">Liaison vers votre compte Binance</h5>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="cle" class="col-form-label">Clé API :</label>
              <input type="text" class="form-control" id="cle">
            </div>
            <div class="mb-3">
              <label for="secret" class="col-form-label">Secret :</label>
              <input type="text" class="form-control" id="secret">
            </div>
          </form>
          <p>Laissez vide si vous voulez juste tester.</p>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="saisie_cle_api()" class="btn btn-secondary">Commencer</button>
        </div>
      </div>
    </div>
  </div>




<!-- TradingView Widget BEGIN -->
<div class="tradingview-widget-container"> 
  <div id="tradingview_b0bb0"></div>
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script type="text/javascript">
  new TradingView.widget(
  {
  "autosize": true,
  "symbol": "BINANCE:BTCUSDT",
  "interval": "D",
  "timezone": "Etc/UTC",
  "theme": "dark",
  "style": "1",
  "locale": "fr",
  "toolbar_bg": "#f1f3f6",
  "enable_publishing": false,
  "withdateranges": true,
  "hide_side_toolbar": false,
  "allow_symbol_change": true,
  "save_image": false,
  "container_id": "tradingview_b0bb0"
}
  );
  </script>
</div>
<!-- TradingView Widget END -->

  
  <h2>Smart buy</h2>

  <table><tr>
    <td>
      <select class="form-select" id="smart_buy_select_paire">
      </select>
    </td>
    <td><input id="smart_buy_input_prix_cible" type="text" class="form-control col-2" placeholder="Prix CIBLE, ex 61234.1234"></td>
    <td><input id="smart_buy_input_ecart" type="text" class="form-control col-2" placeholder="Ecart déclencheur en %, ex 15"></td>
    <td><input id="smart_buy_input_quantite" type="text" class="form-control col-2" placeholder="Quantité, ex 0.5555"></td>
    <td> <button type="button" onclick="smart_buy(false)" id="smart_buy_button_test" class="btn btn-secondary">Test</button></td>
    <td><button type="button" onclick="smart_buy(true)" id="smart_buy_button" class="btn btn-success">Acheter pour de vrai</button></td>
    <td>Solde dispo : 43.23</td>
  </tr></table>
  
  <table class="table table-dark table-striped">

    <thead>
      <tr>
        <th>Paire</th>
        <th>Prix CIBLE</th>
        <th>Ecart déclencheur</th>
        <th>Quantité</th>
        <th>Etat</th>
        <th></th>
        <th>Prix ACTUEL</th>
        <th>PLUS_BAS</th>
        <th>Diff prix ACTUEL/PLUS_BAS</th>
        <th>Date début</th>
        <th>Date CIBLE touchée</th>
        <th>Date vente</th>
      </tr>
    </thead>
    <tbody>
  
  
  
      <tr>
        <th id="smart_buy_paire"></th>
        <th id="smart_buy_prix_cible"></th>
        <td id="smart_buy_ecart"></td>
        <th id="smart_buy_quantite"></th>
        <td  id="smart_buy_etat"></td>
        <td  id="smart_buy_annuler_button"><button type="button" onclick="cancel_smart_buy()" class="btn btn-warning">Annuler</button></td>
        <td id="smart_buy_prix_actuel"></td>
        <td  id="smart_buy_plus_bas"></td>
        <td id="smart_buy_diff"></td>
        <td id="smart_buy_date_debut"></td>
        <td id="smart_buy_date_cible"></td>
        <td id="smart_buy_date_vente"></td>
      </tr>
  
  

  
  
    </tbody>
  </table>

  <h2>Smart sell</h2>

  <table><tr>
    <td>
      <select class="form-select" id="smart_sell_select_paire">
      </select>
    </td>
    <td><input id="smart_sell_input_prix_cible" type="text" class="form-control col-2" placeholder="Prix CIBLE, ex 61234.1234"></td>
    <td><input id="smart_sell_input_ecart" type="text" class="form-control col-2" placeholder="Ecart déclencheur en %, ex 1.5"></td>
    <td><input id="smart_sell_input_quantite" type="text" class="form-control col-2" placeholder="Quantité, ex 0.5555"></td>
    <td> <button type="button" onclick="smart_sell(false)" id="smart_sell_button_test" class="btn btn-secondary">Test</button></td>
    <td><button type="button" onclick="smart_sell(true)" id="smart_sell_button" class="btn btn-danger">Vendre pour de vrai</button></td>
    <td>Solde dispo : 43.23</td>
  </tr></table>

  <table class="table table-dark table-striped">
    <thead>
      <tr>
        <th>Paire</th>
        <th>Prix CIBLE</th>
        <th>Ecart déclencheur</th>
        <th>Quantité</th>
        <th>Etat</th>
        <th></th>
        <th>Prix ACTUEL</th>
        <th>PLUS_HAUT</th>
        <th>Diff prix ACTUEL/PLUS_HAUT</th>
        <th>Date début</th>
        <th>Date CIBLE touchée</th>
        <th>Date vente</th>
      </tr>
    </thead>
    <tbody>
  
  
  
      <tr>
        <th id="smart_sell_paire"></th>
        <th id="smart_sell_prix_cible"></th>
        <td id="smart_sell_ecart"></td>
        <th id="smart_sell_quantite"></th>
        <td  id="smart_sell_etat"></td>
        <td  id="smart_sell_annuler_button"><button type="button" onclick="cancel_smart_sell()" class="btn btn-warning">Annuler</button></td>
        <td id="smart_sell_prix_actuel"></td>
        <td  id="smart_sell_plus_haut"></td>
        <td id="smart_sell_diff"></td>
        <td id="smart_sell_date_debut"></td>
        <td id="smart_sell_date_cible"></td>
        <td id="smart_sell_date_vente"></td>
      </tr>
  
  
  
    </tbody>
  </table>



  <div id="json_div"></div>

  </body>




<script>

//init cle / secret api
var cle="";
var secret="";
//config du modal
var myModal = new bootstrap.Modal(document.getElementById('modalCleAPI'), {
  keyboard: false,
  backdrop: 'static'
  });

//si click sur bouton commencer, ferme modal et attribut valeur cle/secret api
function saisie_cle_api() {
  cle = document.getElementById("cle").innerHTML;
  secret = document.getElementById("secret").innerHTML;
  console.log("clé et secret API attribués");
  myModal.hide()

  console.log("test encrypt pour la future requete signé si ordre - > HMAC SHA256 : "+CryptoJS.HmacSHA256("query", secret));
}

//quand page prete
window.addEventListener('load', function () {

  //rempli le select avec coins existant sur binance
  var xmlhttp = new XMLHttpRequest();
    var url = "https://api.binance.com/api/v3/ticker/price";
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var myArr = JSON.parse(this.responseText);
            for(i = 0; i < myArr.length; i++) {
              document.getElementById("smart_buy_select_paire").options[document.getElementById("smart_buy_select_paire").length] = new Option(myArr[i].symbol, myArr[i].symbol);
              document.getElementById("smart_sell_select_paire").options[document.getElementById("smart_sell_select_paire").length] = new Option(myArr[i].symbol, myArr[i].symbol);
            }
        }
    };
    xmlhttp.open("GET", url, true);
    xmlhttp.send();
  
  //ouvre le modal
  myModal.show();
});






// ------------! SMART BUY !------------

var smart_buy_paire = null;
var smart_buy_prix_cible = null;
var smart_buy_ecart = null;
var smart_buy_quantite = null;
//smart_buy_etat -1 en attente / 0 cible touchée / > 0 prix vendu
var smart_buy_etat = -1;
var smart_buy_prix_actuel = null;
var smart_buy_plus_bas = null;
var smart_buy_diff = null;
var smart_buy_date_debut = null;
var smart_buy_date_cible = null;
var smart_buy_date_vente = null;

var smart_buy_activated = false;
var real_buy = false;

function smart_buy(real_buy_local){
  real_buy = real_buy_local;
  //recupere les infos
  smart_buy_paire = document.getElementById('smart_buy_select_paire').options[document.getElementById('smart_buy_select_paire').selectedIndex].value;
  smart_buy_prix_cible = document.getElementById("smart_buy_input_prix_cible").value;
  smart_buy_ecart = document.getElementById("smart_buy_input_ecart").value;
  smart_buy_quantite = document.getElementById("smart_buy_input_quantite").value;

  smart_buy_activated = true;

  //insert premieres infos dans tab
  document.getElementById("smart_buy_paire").innerHTML = smart_buy_paire;
  document.getElementById("smart_buy_prix_cible").innerHTML = smart_buy_prix_cible;
  document.getElementById("smart_buy_ecart").innerHTML = "+ "+smart_buy_ecart+" %";
  document.getElementById("smart_buy_quantite").innerHTML = smart_buy_quantite;

  document.getElementById("smart_buy_etat").innerHTML = "En attente";

  var now = new Date();
  document.getElementById("smart_buy_date_debut").innerHTML = now.getDate()+"/"+(now.getMonth() + 1) +" à "+now.getHours()+"h"+now.getMinutes()+"m"+now.getSeconds()+"s";


}

//DEBUT CYCLE HORLOGE - TOUTE LES 1 SECONDES si smart buy en cours d'operation
var rep_recu_buy=1;
setInterval(function(){ 

  if(rep_recu_buy==1 && smart_buy_activated){

    var xmlhttp_buy = new XMLHttpRequest();
    var url = "https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT";


    xmlhttp_buy.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var myArr = JSON.parse(this.responseText);
            smart_buy_prix_actuel = myArr.price;

            //TRAITEMENT DEBUT

            //seuil atteint
            if(smart_buy_prix_actuel <= smart_buy_prix_cible && smart_buy_etat==-1){
              smart_buy_etat=0;
              document.getElementById("smart_buy_etat").innerHTML = "Cible touchée";
              smart_buy_plus_bas=999999999999; //1000 milliards -1 on a de la marge bg

              var now = new Date();
              document.getElementById("smart_buy_date_cible").innerHTML = now.getDate()+"/"+(now.getMonth() + 1) +" à "+now.getHours()+"h"+now.getMinutes()+"m"+now.getSeconds()+"s";
            }

            //si pas encore vendu depuis seuil atteint
            if(smart_buy_etat==0){

              //si nouveau bas
              if(smart_buy_prix_actuel<=smart_buy_plus_bas){
                  //on suit la baisse
                  smart_buy_plus_bas = smart_buy_prix_actuel;
                  document.getElementById("smart_buy_plus_bas").innerHTML = smart_buy_plus_bas;
              }
              else{
                  smart_buy_diff = ((smart_buy_prix_actuel/smart_buy_plus_bas)*100)-100;
                  document.getElementById("smart_buy_diff").innerHTML = "+ "+smart_buy_diff + " %";
                  //sinon si prix >= dernier bas * -x %    equivalent à si smart_buy_diff >= x
                  if(smart_buy_prix_actuel>=smart_buy_plus_bas*(1+(smart_buy_ecart/100))){
                      //montée de x % par rapport au dernier bas
                      //on achete.
                      smart_buy_etat=smart_buy_prix_actuel;
                      document.getElementById("smart_buy_etat").innerHTML = "Acheté à "+smart_buy_etat;

                      var now = new Date();
                      document.getElementById("smart_buy_date_vente").innerHTML = now.getDate()+"/"+(now.getMonth() + 1) +" à "+now.getHours()+"h"+now.getMinutes()+"m"+now.getSeconds()+"s";
                  }
              }

            }

            //TRAITEMENT FIN

            document.getElementById("smart_buy_prix_actuel").innerHTML = smart_buy_prix_actuel;
            rep_recu_buy=1;
        }
    };
    xmlhttp_buy.open("GET", url, true);
    xmlhttp_buy.send();

    rep_recu_buy=0;

  }

  if(rep_recu_buy==1 && !smart_buy_activated){
    document.getElementById("smart_buy_paire").innerHTML = "";
    document.getElementById("smart_buy_prix_cible").innerHTML = "";
    document.getElementById("smart_buy_ecart").innerHTML = "";
    document.getElementById("smart_buy_quantite").innerHTML = "";
    document.getElementById("smart_buy_etat").innerHTML = "";
    document.getElementById("smart_buy_prix_actuel").innerHTML = "";
    document.getElementById("smart_buy_plus_bas").innerHTML = "";
    document.getElementById("smart_buy_diff").innerHTML = "";
    document.getElementById("smart_buy_date_debut").innerHTML = "";
    document.getElementById("smart_buy_date_cible").innerHTML = "";
    document.getElementById("smart_buy_date_vente").innerHTML = "";
    smart_buy_paire = null;
    smart_buy_prix_cible = null;
    smart_buy_ecart = null;
    smart_buy_quantite = null;
    smart_buy_etat = -1;
    smart_buy_prix_actuel = null;
    smart_buy_plus_bas = null;
    smart_buy_diff = null;
    smart_buy_date_debut = null;
    smart_buy_date_cible = null;
    smart_buy_date_vente = null;
    smart_buy_activated = false;
    real_buy = false;
  }

}, 1000);//1000ms => 1sec ;)
//FIN CYCLE HORLOGE

function cancel_smart_buy(){
  smart_buy_activated = false;
}

// ------------! FIN SMART BUY !------------





// ------------! SMART SELL !------------

var smart_sell_paire = null;
var smart_sell_prix_cible = null;
var smart_sell_ecart = null;
var smart_sell_quantite = null;
//smart_sell_etat -1 en attente / 0 cible touchée / > 0 prix vendu
var smart_sell_etat = -1;
var smart_sell_prix_actuel = null;
var smart_sell_plus_bas = null;
var smart_sell_diff = null;
var smart_sell_date_debut = null;
var smart_sell_date_cible = null;
var smart_sell_date_vente = null;

var smart_sell_activated = false;
var real_sell = false;

function smart_sell(real_sell_local){
  real_sell = real_sell_local;
  //recupere les infos
  smart_sell_paire = document.getElementById('smart_sell_select_paire').options[document.getElementById('smart_sell_select_paire').selectedIndex].value;
  smart_sell_prix_cible = document.getElementById("smart_sell_input_prix_cible").value;
  smart_sell_ecart = document.getElementById("smart_sell_input_ecart").value;
  smart_sell_quantite = document.getElementById("smart_sell_input_quantite").value;

  smart_sell_activated = true;

  //insert premieres infos dans tab
  document.getElementById("smart_sell_paire").innerHTML = smart_sell_paire;
  document.getElementById("smart_sell_prix_cible").innerHTML = smart_sell_prix_cible;
  document.getElementById("smart_sell_ecart").innerHTML = "- "+smart_sell_ecart+" %";
  document.getElementById("smart_sell_quantite").innerHTML = smart_sell_quantite;

  document.getElementById("smart_sell_etat").innerHTML = "En attente";

  var now = new Date();
  document.getElementById("smart_sell_date_debut").innerHTML = now.getDate()+"/"+(now.getMonth() + 1) +" à "+now.getHours()+"h"+now.getMinutes()+"m"+now.getSeconds()+"s";


}

//DEBUT CYCLE HORLOGE - TOUTE LES 1 SECONDES si smart sell en cours d'operation
var rep_recu_sell=1;
setInterval(function(){ 

  if(rep_recu_sell==1 && smart_sell_activated){

    var xmlhttp_sell = new XMLHttpRequest();
    var url = "https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT";


    xmlhttp_sell.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var myArr = JSON.parse(this.responseText);
            smart_sell_prix_actuel = myArr.price;

            //TRAITEMENT DEBUT

            //seuil atteint
            if(smart_sell_prix_actuel >= smart_sell_prix_cible && smart_sell_etat==-1){
              smart_sell_etat=0;
              document.getElementById("smart_sell_etat").innerHTML = "Cible touchée";
              smart_sell_plus_haut=0;

              var now = new Date();
              document.getElementById("smart_sell_date_cible").innerHTML = now.getDate()+"/"+(now.getMonth() + 1) +" à "+now.getHours()+"h"+now.getMinutes()+"m"+now.getSeconds()+"s";
            }

            //si pas encore vendu depuis seuil atteint
            if(smart_sell_etat==0){

              //si nouveau top
              if(smart_sell_prix_actuel>=smart_sell_plus_haut){
                  //on suit la montée
                  smart_sell_plus_haut = smart_sell_prix_actuel;
                  document.getElementById("smart_sell_plus_haut").innerHTML = smart_sell_plus_haut;
              }
              else{
                  smart_sell_diff = 100-((smart_sell_prix_actuel/smart_sell_plus_haut)*100);
                  document.getElementById("smart_sell_diff").innerHTML = "- "+smart_sell_diff + " %";
                  //sinon si prix <= dernier top * -x %    equivalent à si smart_sell_diff <= x
                  if(smart_sell_prix_actuel<=smart_sell_plus_haut*(1-(smart_sell_ecart/100))){
                      //baise de x % par rapport au dernier top
                      //on vend.
                      smart_sell_etat=smart_sell_prix_actuel;
                      document.getElementById("smart_sell_etat").innerHTML = "Vendu à "+smart_sell_etat;

                      var now = new Date();
                      document.getElementById("smart_sell_date_vente").innerHTML = now.getDate()+"/"+(now.getMonth() + 1) +" à "+now.getHours()+"h"+now.getMinutes()+"m"+now.getSeconds()+"s";
                  }
              }

            }

            //TRAITEMENT FIN

            document.getElementById("smart_sell_prix_actuel").innerHTML = smart_sell_prix_actuel;
            rep_recu_sell=1;
        }
    };
    xmlhttp_sell.open("GET", url, true);
    xmlhttp_sell.send();

    rep_recu_sell=0;

  }

  if(rep_recu_sell==1 && !smart_sell_activated){
    document.getElementById("smart_sell_paire").innerHTML = "";
    document.getElementById("smart_sell_prix_cible").innerHTML = "";
    document.getElementById("smart_sell_ecart").innerHTML = "";
    document.getElementById("smart_sell_quantite").innerHTML = "";
    document.getElementById("smart_sell_etat").innerHTML = "";
    document.getElementById("smart_sell_prix_actuel").innerHTML = "";
    document.getElementById("smart_sell_plus_haut").innerHTML = "";
    document.getElementById("smart_sell_diff").innerHTML = "";
    document.getElementById("smart_sell_date_debut").innerHTML = "";
    document.getElementById("smart_sell_date_cible").innerHTML = "";
    document.getElementById("smart_sell_date_vente").innerHTML = "";
    smart_sell_paire = null;
    smart_sell_prix_cible = null;
    smart_sell_ecart = null;
    smart_sell_quantite = null;
    smart_sell_etat = -1;
    smart_sell_prix_actuel = null;
    smart_sell_plus_bas = null;
    smart_sell_diff = null;
    smart_sell_date_debut = null;
    smart_sell_date_cible = null;
    smart_sell_date_vente = null;
    smart_sell_activated = false;
    real_sell = false;
  }

}, 1000);//1000ms => 1sec ;)
//FIN CYCLE HORLOGE

function cancel_smart_sell(){
  smart_sell_activated = false;
}

// ------------! FIN SMART SELL !------------







//TO DO
//add quantite dispo sur wallet spot binance de la paire select
//xmlhttp market buy/sell if real_buy / real_sell
//creer array pour plusieurs smart sell/buy
//ameliorer interface 
//bouton cible actuel profiter pump/dump ! - changer fonctionnalites.html alors
//mettre code smart sell/buy dans js ext


</script>


</html>
